
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETA Pilot Study Stress Challenge (Participant)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { transition: opacity 0.5s ease-in-out; }
        .hidden { display: none; }
        .stress-option.selected {
            background-color: #e0e7ff; /* indigo-200 */
            border-color: #6366f1; /* indigo-500 */
            font-weight: 600;
            box-shadow: 0 0 0 2px #818cf8; /* indigo-400 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="main-content" class="w-full">
        <div id="app-container" class="bg-white p-4 sm:p-8 rounded-2xl shadow-2xl max-w-5xl w-full text-center relative transition-all duration-500 mx-auto">
            
            <div id="sessionIdContainer" class="absolute bottom-4 left-4 bg-indigo-100 text-indigo-800 text-sm font-semibold px-4 py-2 rounded-lg shadow-md hidden">
                Session ID: <span id="sessionIdDisplay" class="font-bold"></span>
            </div>

            <!-- Screen: Welcome -->
            <div id="welcome" class="screen">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 mb-4">BETA Pilot Study Stress Challenge</h1>
                    <p class="text-gray-600 mb-8 text-lg">This test will take approximately 30 minutes. Please wait for the researcher to begin the session.</p>
                </div>
            </div>

            <!-- Screen: Pre-Baseline Survey -->
            <div id="preBaselineSurvey" class="screen hidden">
                <div class="max-w-4xl mx-auto text-left space-y-4">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Log Your Stress Level</h2>
                    <p>Please select your current stress level from the options below. Your selection will be shared with the researcher.</p>
                    <div class="my-4 p-4 border rounded-lg bg-gray-50">
                        <p class="font-bold">What is your current stress level?</p>
                        <div id="preStressSurveyOptions" class="stress-option-group mt-2 space-y-2" data-survey-type="pre">
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Very stressed">😰 Very stressed</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Stressed">😨 Stressed</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Somewhat stressed">😥 Somewhat stressed</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Neutral">😶 Neutral</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Not stressed at all">😌 Not stressed at all</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="No answer">⚪️ No answer</div>
                        </div>
                    </div>
                    <p class="text-center font-semibold text-indigo-600 mt-4">Waiting for the researcher to continue...</p>
                </div>
            </div>

            <!-- Screen: Resting Baseline -->
            <div id="baseline" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Resting Baseline</h2>
                    <p class="text-gray-600 mb-6">Please sit quietly and try to relax. The researcher will start the timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="baselineTimer">3:00</div>
                </div>
            </div>

            <!-- Screen: Speech Preparation -->
            <div id="speechPreparation" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Speech Preparation</h2>
                    <p class="text-gray-600 mb-6 text-left">You have 5 minutes to prepare a persuasive speech for your dream job interview. Please think silently and do not write any notes. The researcher will start the timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="prepTimer">5:00</div>
                </div>
            </div>
            
            <!-- Screen: Speech Delivery -->
            <div id="speechDelivery" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Speech Delivery</h2>
                    <p class="text-gray-600 mb-6">Please begin your 5-minute speech now. Remember, no notes. The researcher will start the timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="speechTimer">5:00</div>
                </div>
            </div>

            <!-- Screen: Mental Arithmetic -->
            <div id="mentalArithmetic" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Mental Math Challenge</h2>
                    <p class="text-gray-600 mb-2">Starting from <strong>2,023</strong>, subtract <strong>17</strong> repeatedly. Speak each result aloud.</p>
                    <p class="text-gray-500 mb-6">If you make an error, you will be told to start again from 2,023. The researcher will start the timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="mathTimer">5:00</div>
                </div>
            </div>

            <!-- Screen: Post-Task Survey -->
            <div id="postTaskSurvey" class="screen hidden">
                 <div class="max-w-4xl mx-auto text-left space-y-4">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Log Your Stress Level</h2>
                    <p>Please select your current stress level from the options below. Your selection will be shared with the researcher.</p>
                    <div class="my-4 p-4 border rounded-lg bg-gray-50">
                        <p class="font-bold">What is your current stress level?</p>
                        <div id="postStressSurveyOptions" class="stress-option-group mt-2 space-y-2" data-survey-type="post">
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Very stressed">😰 Very stressed</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Stressed">😨 Stressed</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Somewhat stressed">😥 Somewhat stressed</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Neutral">😶 Neutral</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="Not stressed at all">😌 Not stressed at all</div>
                            <div class="stress-option p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 flex items-center gap-3 transition-all" data-value="No answer">⚪️ No answer</div>
                        </div>
                    </div>
                    <p class="text-center font-semibold text-indigo-600 mt-4">Waiting for the researcher to continue...</p>
                </div>
            </div>

            <!-- Screen: Meal -->
            <div id="meal" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Meal Time</h2>
                    <p class="text-gray-600 mb-6">Please consume the provided liquid meal. The researcher will start the 5-minute timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="mealTimer">5:00</div>
                </div>
            </div>

            <!-- Screen: Complete -->
            <div id="complete" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-5xl font-extrabold text-green-600 mb-4">Challenge Complete</h1>
                    <div class="text-gray-700 text-lg mb-4 bg-indigo-50 p-6 rounded-lg">
                        <p>Thank you for your participation. Please remember to avoid food, beverages (other than water), and strenuous or stressful activity until:</p>
                        <p id="endTimeDisplay" class="text-4xl font-bold text-indigo-600 my-4"></p>
                    </div>
                    <p class="text-gray-600">You may now close this page.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        let db, auth;
        let sessionId = null;
        let gameState = {};
        let mainTimer = null;
        let remainingSeconds = 0;
        let lastCommandId = null;
        let sessionStartTime = null;

        const screenConfig = {
            'baseline': { timerId: 'baselineTimer', duration: 180 },
            'speechPreparation': { timerId: 'prepTimer', duration: 300 },
            'speechDelivery': { timerId: 'speechTimer', duration: 300 },
            'mentalArithmetic': { timerId: 'mathTimer', duration: 300 },
            'meal': { timerId: 'mealTimer', duration: 300 },
        };

        window.onload = function() {
            const firebaseConfig = {
                apiKey: "AIzaSyC-Yc9Vr2aWSc1u8YCNVFk48ijcix2Sg2c",
                authDomain: "tsst-d6836.firebaseapp.com",
                projectId: "tsst-d6836",
                storageBucket: "tsst-d6836.appspot.com",
                messagingSenderId: "55426434749",
                appId: "1:55426434749:web:441d29af1ce3529a6019d4"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');
                signIn();
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('main-content').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl"><h1 class="text-2xl font-bold text-red-600">Error: Could not connect to the server.</h1></div>`;
            }
        };

        async function signIn() {
            try {
                await signInAnonymously(auth);
                initializeSession();
            } catch (error) {
                console.error("Authentication Error", error);
                document.getElementById('main-content').innerHTML = `<h1>Authentication Failed</h1><p>${error.message}</p>`;
            }
        }

        function initializeSession() {
            sessionStartTime = new Date();
            sessionId = generateSessionId();
            document.getElementById('sessionIdDisplay').textContent = sessionId;
            document.getElementById('sessionIdContainer').classList.remove('hidden');
            
            const userId = auth.currentUser?.uid || 'anonymous';
            const appId = "tsst-d6836";
            const timezoneOffset = new Date().getTimezoneOffset();
            
            gameState = {
                screenId: 'welcome',
                sessionId: sessionId,
                participantId: userId,
                appId: appId,
                timezoneOffset: timezoneOffset,
                timer: { running: false, value: '0:00' },
                stressResponsePre: null,
                stressResponsePost: null
            };
            updateGameState(gameState);
            listenForCommands();
            setupInteractiveSurveys();
        }

        function setupInteractiveSurveys() {
            document.querySelectorAll('.stress-option-group').forEach(group => {
                group.addEventListener('click', (event) => {
                    const selectedOption = event.target.closest('.stress-option');
                    if (!selectedOption) return;

                    group.querySelectorAll('.stress-option').forEach(opt => opt.classList.remove('selected'));
                    selectedOption.classList.add('selected');

                    const surveyType = group.dataset.surveyType;
                    const value = selectedOption.dataset.value;

                    if (surveyType === 'pre') {
                        updateGameState({ stressResponsePre: value });
                    } else if (surveyType === 'post') {
                        updateGameState({ stressResponsePost: value });
                    }
                });
            });
        }

        function listenForCommands() {
            const appId = "tsst-d6836";
            const sessionRef = doc(db, `artifacts/${appId}/public/data/sessions`, sessionId);
            onSnapshot(sessionRef, (doc) => {
                const data = doc.data();
                if (data && data.command && data.command.commandId !== lastCommandId) {
                    lastCommandId = data.command.commandId;
                    handleCommand(data.command);
                }
            });
        }

        function handleCommand(command) {
            if (command.type === 'screen') {
                showScreen(command.screenId);
            } else if (command.type === 'timer') {
                const currentScreenConfig = screenConfig[gameState.screenId];
                if (!currentScreenConfig) return;

                if (command.action === 'start') {
                    startMainTimer(currentScreenConfig.timerId, remainingSeconds > 0 ? remainingSeconds : currentScreenConfig.duration);
                } else if (command.action === 'stop') {
                    stopMainTimer();
                } else if (command.action === 'reset') {
                    resetMainTimer(currentScreenConfig.timerId, currentScreenConfig.duration);
                }
            }
        }

        function updateGameState(newState) {
            gameState = { ...gameState, ...newState };
            const appId = gameState.appId || 'tsst-d6836';
            if (db && sessionId) {
                const sessionRef = doc(db, `artifacts/${appId}/public/data/sessions`, sessionId);
                const dataToSet = {
                    ...gameState,
                    lastUpdate: serverTimestamp()
                };
                setDoc(sessionRef, dataToSet, { merge: true });
            }
        }

        function showScreen(screenId) {
            stopMainTimer();
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const screenEl = document.getElementById(screenId);
            if (screenEl) screenEl.classList.remove('hidden');

            if (screenId === 'complete' && sessionStartTime) {
                const endTime = new Date(sessionStartTime.getTime() + (2 * 60 * 60 * 1000)); // 2 hours
                const endTimeString = endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('endTimeDisplay').textContent = endTimeString;
            }
            
            gameState.screenId = screenId;
            const currentScreenConfig = screenConfig[screenId];
            if (currentScreenConfig) {
                resetMainTimer(currentScreenConfig.timerId, currentScreenConfig.duration);
            } else {
                updateGameState({ timer: { running: false, value: '' } });
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function startMainTimer(timerId, duration) {
            clearInterval(mainTimer);
            remainingSeconds = duration;
            const timerElement = document.getElementById(timerId);
            
            updateGameState({ timer: { running: true, value: formatTime(remainingSeconds) } });

            mainTimer = setInterval(() => {
                remainingSeconds--;
                if(timerElement) timerElement.textContent = formatTime(remainingSeconds);
                updateGameState({ timer: { running: true, value: formatTime(remainingSeconds) } });

                if (remainingSeconds <= 0) {
                    stopMainTimer();
                }
            }, 1000);
        }

        function stopMainTimer() {
            clearInterval(mainTimer);
            if (gameState.timer) {
                updateGameState({ timer: { ...gameState.timer, running: false } });
            }
        }

        function resetMainTimer(timerId, duration) {
            stopMainTimer();
            remainingSeconds = duration;
            const timerElement = document.getElementById(timerId);
            if(timerElement) timerElement.textContent = formatTime(duration);
            updateGameState({ timer: { running: false, value: formatTime(duration) } });
        }

        function generateSessionId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
    </script>
</body>
</html>
